<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 3.9.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.ico"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/all.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"www.liuvv.com",root:"/",scheme:"Pisces",version:"7.8.0",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1,dimmer:!1},copycode:{enable:!1,show_result:!1,style:null},back2top:{enable:!0,sidebar:!1,scrollpercent:!1},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},path:"search.json"}</script><meta name="description" content="1. https 协议HTTPS 协议（HyperText Transfer Protocol over Secure Socket Layer）：可以理解为HTTP+SSL/TLS， 即 HTTP 下加入 SSL 层，HTTPS 的安全基础是 SSL，因此加密的详细内容就需要 SSL，用于安全的 HTTP 数据传输。"><meta name="keywords" content="linux,http"><meta property="og:type" content="article"><meta property="og:title" content="https协议"><meta property="og:url" content="https://www.liuvv.com/p/be73ec63.html"><meta property="og:site_name" content="Levonfly&#39;s Blog"><meta property="og:description" content="1. https 协议HTTPS 协议（HyperText Transfer Protocol over Secure Socket Layer）：可以理解为HTTP+SSL/TLS， 即 HTTP 下加入 SSL 层，HTTPS 的安全基础是 SSL，因此加密的详细内容就需要 SSL，用于安全的 HTTP 数据传输。"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://www.liuvv.com/p/https%E5%8D%8F%E8%AE%AE/a.jpg"><meta property="og:image" content="https://www.liuvv.com/p/https%E5%8D%8F%E8%AE%AE/b.jpg"><meta property="og:image" content="https://www.liuvv.com/p/https%E5%8D%8F%E8%AE%AE/c.jpg"><meta property="og:image" content="https://www.liuvv.com/p/https%E5%8D%8F%E8%AE%AE/d.jpg"><meta property="og:image" content="https://www.liuvv.com/p/https%E5%8D%8F%E8%AE%AE/e.jpg"><meta property="og:image" content="https://www.liuvv.com/p/https%E5%8D%8F%E8%AE%AE/0.jpg"><meta property="og:image" content="https://www.liuvv.com/p/https%E5%8D%8F%E8%AE%AE/1.jpg"><meta property="og:image" content="https://www.liuvv.com/p/https%E5%8D%8F%E8%AE%AE/2.jpg"><meta property="og:image" content="https://www.liuvv.com/p/https%E5%8D%8F%E8%AE%AE/3.jpg"><meta property="og:image" content="https://www.liuvv.com/p/https%E5%8D%8F%E8%AE%AE/4.jpg"><meta property="og:image" content="https://www.liuvv.com/p/https%E5%8D%8F%E8%AE%AE/5.jpg"><meta property="og:image" content="https://www.liuvv.com/p/https%E5%8D%8F%E8%AE%AE/6.jpg"><meta property="og:image" content="https://www.liuvv.com/p/https%E5%8D%8F%E8%AE%AE/7.jpg"><meta property="og:image" content="https://www.liuvv.com/p/https%E5%8D%8F%E8%AE%AE/11.jpg"><meta property="og:image" content="https://www.liuvv.com/p/https%E5%8D%8F%E8%AE%AE/12.jpg"><meta property="og:image" content="https://www.liuvv.com/p/https%E5%8D%8F%E8%AE%AE/13.jpg"><meta property="og:updated_time" content="2021-07-13T10:28:10.976Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="https协议"><meta name="twitter:description" content="1. https 协议HTTPS 协议（HyperText Transfer Protocol over Secure Socket Layer）：可以理解为HTTP+SSL/TLS， 即 HTTP 下加入 SSL 层，HTTPS 的安全基础是 SSL，因此加密的详细内容就需要 SSL，用于安全的 HTTP 数据传输。"><meta name="twitter:image" content="https://www.liuvv.com/p/https%E5%8D%8F%E8%AE%AE/a.jpg"><link rel="canonical" href="https://www.liuvv.com/p/be73ec63.html"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0,lang:"zh-CN"}</script><title>https协议 | Levonfly's Blog</title><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?521e5dbc31dd12bb9431823008da3dfc";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span><h1 class="site-title">Levonfly's Blog</h1><span class="logo-line-after"><i></i></span></a><p class="site-subtitle" itemprop="description">微信: L6241425</p></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul id="menu" class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="home fa-fw"></i>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="archive fa-fw"></i>日志</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="th fa-fw"></i>分类</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="user fa-fw"></i>关于</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"><div id="no-result"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div><a href="https://github.com/unix2dos" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content post posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.liuvv.com/p/be73ec63.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="levonfly"><meta itemprop="description" content="Keep it simple, stupid."></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Levonfly's Blog"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">https协议</h1><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2019-07-18 19:08:00" itemprop="dateCreated datePublished" datetime="2019-07-18T19:08:00+08:00">2019-07-18</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2021-07-13 18:28:10" itemprop="dateModified" datetime="2021-07-13T18:28:10+08:00">2021-07-13</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/3-计算机系统/" itemprop="url" rel="index"><span itemprop="name">3-计算机系统</span></a> </span>， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/3-计算机系统/https/" itemprop="url" rel="index"><span itemprop="name">https</span></a> </span></span><span id="/p/be73ec63.html" class="post-meta-item leancloud_visitors" data-flag-title="https协议" title="阅读次数"><span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="post-meta-item-text">阅读次数：</span> <span class="leancloud-visitors-count"></span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i> </span><span class="post-meta-item-text">Valine：</span> <a title="valine" href="/p/be73ec63.html#valine-comments" itemprop="discussionUrl"><span class="post-comments-count valine-comment-count" data-xid="/p/be73ec63.html" itemprop="commentCount"></span></a></span><br><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>5.8k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>5 分钟</span></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="1-https-协议"><a href="#1-https-协议" class="headerlink" title="1. https 协议"></a>1. https 协议</h1><p>HTTPS 协议（HyperText Transfer Protocol over Secure Socket Layer）：可以理解为HTTP+SSL/TLS， 即 HTTP 下加入 SSL 层，HTTPS 的安全基础是 SSL，因此加密的详细内容就需要 SSL，用于安全的 HTTP 数据传输。</p><a id="more"></a><blockquote><p>SSL历史和版本</p></blockquote><p>1994年，NetScape公司设计了SSL协议（Secure Sockets Layer）的1.0版，但是未发布。</p><p>1995年，NetScape公司发布SSL 2.0版，很快发现有严重漏洞。</p><p>1996年，SSL 3.0版问世，得到大规模应用。</p><p>1999年，互联网标准化组织ISOC接替NetScape公司，发布了SSL的升级版TLS 1.0版。</p><p>2006年和2008年，TLS进行了两次升级，分别为TLS 1.1版和TLS 1.2版。最新的变动是2011年TLS 1.2的修订版。</p><p>目前，应用最广泛的是TLS 1.0，接下来是SSL 3.0。但是，主流浏览器都已经实现了TLS 1.2的支持。</p><hr><p>TLS 1.0通常被标示为SSL 3.1</p><p>TLS 1.1为SSL 3.2，</p><p>TLS 1.2为SSL 3.3。</p><h1 id="2-数字证书"><a href="#2-数字证书" class="headerlink" title="2. 数字证书"></a>2. 数字证书</h1><p>数字证书，又称互联网上的”身份证”，用于唯一标识一个组织或一个服务器的，这就好比我们日常生活中使用的”居民身份证”，用于唯一标识一个人。</p><p>网站的证书也是同样的道理。一般来说数字证书从受信的权威证书授权机构 (Certification Authority，证书授权机构)买来的。一般浏览器在出厂时就内置了诸多知名CA。</p><p>实际应用中，HTTPS并非直接传输公钥信息，而是使用携带公钥信息的数字证书来保证公钥的安全性和完整性。用来保障HTTPS服务端发送给客户端的公钥信息不被篡改。</p><h3 id="2-1-数字证书和-CA-机构"><a href="#2-1-数字证书和-CA-机构" class="headerlink" title="2.1 数字证书和 CA 机构"></a>2.1 数字证书和 CA 机构</h3><p>一个数字证书通常包含了：</p><ul><li>公钥；</li><li>持有者信息；</li><li>证书认证机构（CA）的信息；</li><li>CA 对这份文件的数字签名及使用的算法；</li><li>证书有效期；</li><li>还有一些其他额外信息；</li></ul><p>那数字证书的作用，是用来认证公钥持有者的身份，以防止第三方进行冒充。说简单些，证书就是用来告诉客户端，该服务端是否是合法的，因为只有证书合法，才代表服务端身份是可信的。</p><p>我们用证书来认证公钥持有者的身份（服务端的身份），那证书又是怎么来的？又该怎么认证证书呢？</p><p>为了让服务端的公钥被大家信任，服务端的证书都是由 CA （<em>Certificate Authority</em>，证书认证机构）签名的，CA 就是网络世界里的公安局、公证中心，具有极高的可信度，所以由它来给各个公钥签名，信任的一方签发的证书，那必然证书也是被信任的。</p><p>之所以要签名，是因为签名的作用可以避免中间人在获取证书时对证书内容的篡改。</p><h3 id="2-2-数字证书签发和验证流程"><a href="#2-2-数字证书签发和验证流程" class="headerlink" title="2.2 数字证书签发和验证流程"></a>2.2 数字证书签发和验证流程</h3><p>如下图图所示，为数字证书签发和验证流程：</p><p><img src="https%E5%8D%8F%E8%AE%AE/a.jpg" alt="1"></p><ol><li>CA 签发证书的过程，如上图左边部分：</li></ol><ul><li>首先 CA 会把持有者的公钥、用途、颁发者、有效时间等信息打成一个包，然后对这些信息进行 Hash 计算，得到一个 Hash 值；</li><li>然后 CA 会使用自己的私钥将该 Hash 值加密，生成 Certificate Signature，也就是 CA 对证书做了签名；</li><li>最后将 Certificate Signature 添加在文件证书上，形成数字证书；</li></ul><ol start="2"><li>客户端校验服务端的数字证书的过程，如上图右边部分：</li></ol><ul><li>首先客户端会使用同样的 Hash 算法获取该证书的 Hash 值 H1；</li><li>通常浏览器和操作系统中集成了 CA 的公钥信息，浏览器收到服务器的证书后可以使用 CA 的公钥解密 Certificate Signature 内容，得到一个 Hash 值 H2 ；</li><li>最后比较 H1 和 H2，如果值相同，则为可信赖的证书，否则则认为服务器证书不可信。</li></ul><h3 id="2-3-证书链"><a href="#2-3-证书链" class="headerlink" title="2.3 证书链"></a>2.3 证书链</h3><p>但事实上，证书的验证过程中还存在一个证书信任链的问题，因为我们向 CA 申请的证书一般不是根证书签发的，而是由中间证书签发的，比如百度的证书，从下图你可以看到，证书的层级有三级：<br><img src="https%E5%8D%8F%E8%AE%AE/b.jpg" alt="1"></p><p>对于这种三级层级关系的证书的验证过程如下：</p><ul><li>客户端收到 <a href="https://link.zhihu.com/?target=http%3A//baidu.com/" target="_blank" rel="noopener">baidu.com</a> 的证书后，发现这个证书的签发者不是根证书，就无法根据本地已有的根证书中的公钥去验证 <a href="https://link.zhihu.com/?target=http%3A//baidu.com/" target="_blank" rel="noopener">baidu.com</a> 证书是否可信。于是，客户端根据 <a href="https://link.zhihu.com/?target=http%3A//baidu.com/" target="_blank" rel="noopener">baidu.com</a> 证书中的签发者，找到该证书的颁发机构是 “GlobalSign Organization Validation CA - SHA256 - G2”，然后向 CA 请求该中间证书。</li><li>请求到证书后发现 “GlobalSign Organization Validation CA - SHA256 - G2” 证书是由 “GlobalSign Root CA” 签发的，由于 “GlobalSign Root CA” 没有再上级签发机构，说明它是根证书，也就是自签证书。应用软件会检查此证书有否已预载于根证书清单上，如果有，则可以利用根证书中的公钥去验证 “GlobalSign Organization Validation CA - SHA256 - G2” 证书，如果发现验证通过，就认为该中间证书是可信的。</li><li>“GlobalSign Organization Validation CA - SHA256 - G2” 证书被信任后，可以使用 “GlobalSign Organization Validation CA - SHA256 - G2” 证书中的公钥去验证 <a href="https://link.zhihu.com/?target=http%3A//baidu.com/" target="_blank" rel="noopener">baidu.com</a> 证书的可信性，如果验证通过，就可以信任 <a href="https://link.zhihu.com/?target=http%3A//baidu.com/" target="_blank" rel="noopener">baidu.com</a> 证书。</li></ul><p>在这些步骤中，最开始客户端只信任根证书 GlobalSign Root CA 证书的，然后 “GlobalSign Root CA” 证书信任 “GlobalSign Organization Validation CA - SHA256 - G2” 证书，而 “GlobalSign Organization Validation CA - SHA256 - G2” 证书又信任 <a href="https://link.zhihu.com/?target=http%3A//baidu.com/" target="_blank" rel="noopener">baidu.com</a> 证书，于是客户端也信任 <a href="https://link.zhihu.com/?target=http%3A//baidu.com/" target="_blank" rel="noopener">baidu.com</a>证书。</p><p>总括来说，由于用户信任 GlobalSign，所以由 GlobalSign 所担保的 <a href="https://link.zhihu.com/?target=http%3A//baidu.com/" target="_blank" rel="noopener">baidu.com</a> 可以被信任，另外由于用户信任操作系统或浏览器的软件商，所以由软件商预载了根证书的 GlobalSign 都可被信任。</p><p><img src="https%E5%8D%8F%E8%AE%AE/c.jpg" alt="1"></p><p>操作系统里一般都会内置一些根证书，比如我的 MAC 电脑里内置的根证书有这么多：</p><p><img src="https%E5%8D%8F%E8%AE%AE/d.jpg" alt="1"></p><p>这样的一层层地验证就构成了一条信任链路，整个证书信任链验证流程如下图所示：</p><p><img src="https%E5%8D%8F%E8%AE%AE/e.jpg" alt="1"></p><p>最后一个问题，为什么需要证书链这么麻烦的流程？Root CA 为什么不直接颁发证书，而是要搞那么多中间层级呢？</p><p>这是为了确保根证书的绝对安全性，将根证书隔离地越严格越好，不然根证书如果失守了，那么整个信任链都会有问题。</p><h1 id="3-tls-四次握手"><a href="#3-tls-四次握手" class="headerlink" title="3. tls 四次握手"></a>3. tls 四次握手</h1><p>用 Wireshark 工具抓了用 RSA 密钥交换的 TLS 握手过程，你可以从下面看到，一共经历来四次握手</p><p><img src="https%E5%8D%8F%E8%AE%AE/0.jpg" alt="1"></p><h3 id="3-1-客户端向服务端发送-Client-Hello-消息"><a href="#3-1-客户端向服务端发送-Client-Hello-消息" class="headerlink" title="3.1 客户端向服务端发送 Client Hello 消息"></a>3.1 客户端向服务端发送 <strong>Client Hello</strong> 消息</h3><p>客户端首先会发一个「<strong>Client Hello</strong>」消息，字面意思我们也能理解到，这是跟服务器「打招呼」。</p><p>消息里面有客户端使用的 TLS 版本号、支持的密码套件列表，以及生成的随机数（Client Random），这个随机数会被服务端保留，它是生成对称加密密钥的材料之一。</p><p><img src="https%E5%8D%8F%E8%AE%AE/1.jpg" alt="1"></p><h3 id="3-2-服务端向客户端发送-Server-Hello-消息"><a href="#3-2-服务端向客户端发送-Server-Hello-消息" class="headerlink" title="3.2 服务端向客户端发送 Server Hello 消息"></a>3.2 服务端向客户端发送 <strong>Server Hello</strong> 消息</h3><p>当服务端收到客户端的「Client Hello」消息后，会确认 TLS 版本号是否支持，和从密码套件列表中选择一个密码套件，以及生成随机数（Server Random）。</p><p>接着，返回「Server Hello」消息，消息里面有服务器确认的 TLS 版本号，也给出了随机数（Server Random），然后从客户端的密码套件列表选择了一个合适的密码套件。</p><p><img src="https%E5%8D%8F%E8%AE%AE/2.jpg" alt="1"></p><p>可以看到，服务端选择的密码套件是 “Cipher Suite: TLS_RSA_WITH_AES_128_GCM_SHA256”。</p><p>这个密码套件看起来真让人头晕，好一大串，但是其实它是有固定格式和规范的。基本的形式是「<strong>密钥交换算法 + 签名算法 + 对称加密算法 + 摘要算法</strong>」， 一般 WITH 单词前面有两个单词，第一个单词是约定密钥交换的算法，第二个单词是约定证书的验证算法。比如刚才的密码套件的意思就是：</p><ul><li><p>由于 WITH 单词只有一个 RSA，则说明握手时密钥交换算法和签名算法都是使用 RSA；</p></li><li><p>握手后的通信使用 AES 对称算法，密钥长度 128 位，分组模式是 GCM；</p></li><li><p>摘要算法 SHA256 用于消息认证和产生随机数；</p></li></ul><p>就前面这两个客户端和服务端相互「打招呼」的过程，客户端和服务端就已确认了 TLS 版本和使用的密码套件，而且你可能发现客户端和服务端都会各自生成一个随机数，并且还会把随机数传递给对方。那这个随机数有啥用呢？其实这两个随机数是后续作为生成「会话密钥」的条件，所谓的会话密钥就是数据传输时，所使用的对称加密密钥。</p><p>然后，服务端为了证明自己的身份，会发送「<strong>Server Certificate</strong>」给客户端，这个消息里含有数字证书。</p><p><img src="https%E5%8D%8F%E8%AE%AE/3.jpg" alt="1"></p><p>随后，服务端发了「<strong>Server Hello Done</strong>」消息，目的是告诉客户端，我已经把该给你的东西都给你了，本次打招呼完毕。</p><p><img src="https%E5%8D%8F%E8%AE%AE/4.jpg" alt="1"></p><h3 id="3-3-客户端验证-服务器证书-和-协商密钥"><a href="#3-3-客户端验证-服务器证书-和-协商密钥" class="headerlink" title="3.3 客户端验证 服务器证书 和 协商密钥"></a>3.3 客户端验证 服务器证书 和 协商密钥</h3><p>客户端去验证完证书后，认为可信则继续往下走。接着，客户端就会生成一个新的随机数 (pre-master)，用服务器的 RSA 公钥加密该随机数，通过「Change Cipher Key Exchange」消息传给服务端。</p><p><img src="https%E5%8D%8F%E8%AE%AE/5.jpg" alt="1"></p><p>服务端收到后，用 RSA 私钥解密，得到客户端发来的随机数 (pre-master)。</p><p>至此，<strong>客户端和服务端双方都共享了三个随机数，分别是 Client Random、Server Random、pre-master</strong>。</p><p>于是，双方根据已经得到的三个随机数，生成<strong>会话密钥（Master Secret）</strong>，它是对称密钥，用于对后续的 HTTP 请求/响应的数据加解密。</p><p>生成完会话密钥后，然后客户端发一个「<strong>Change Cipher Spec</strong>」，告诉服务端开始使用加密方式发送消息。</p><p><img src="https%E5%8D%8F%E8%AE%AE/6.jpg" alt="1"></p><p>然后，客户端再发一个「<strong>Encrypted Handshake Message（Finishd）</strong>」消息，把之前所有发送的数据做个摘要，再用会话密钥（master secret）加密一下，让服务器做个验证，验证加密通信是否可用和之前握手信息是否有被中途篡改过。</p><p><img src="https%E5%8D%8F%E8%AE%AE/7.jpg" alt="1"></p><p>可以发现，「Change Cipher Spec」之前传输的 TLS 握手数据都是明文，之后都是对称密钥加密的密文。</p><h3 id="3-4-服务端向客户端发送-Finished-消息"><a href="#3-4-服务端向客户端发送-Finished-消息" class="headerlink" title="3.4 服务端向客户端发送 Finished 消息"></a>3.4 服务端向客户端发送 Finished 消息</h3><p>服务器也是同样的操作，发「<strong>Change Cipher Spec</strong>」和「<strong>Encrypted Handshake Message</strong>」消息，如果双方都验证加密和解密没问题，那么握手正式完成。</p><p>最后，就用「会话密钥」加解密 HTTP 请求和响应了。</p><h1 id="4-优化https"><a href="#4-优化https" class="headerlink" title="4. 优化https"></a>4. 优化https</h1><h3 id="4-1-密钥交换算法优化"><a href="#4-1-密钥交换算法优化" class="headerlink" title="4.1 密钥交换算法优化"></a>4.1 密钥交换算法优化</h3><p>尽量<strong>选用 ECDHE 密钥交换</strong>算法替换 RSA 算法，因为该算法由于支持「False Start」，它是“抢跑”的意思，客户端可以在 TLS 协议的第 3 次握手后，第 4 次握手前，发送加密的应用数据，以此将 <strong>TLS 握手的消息往返由 2 RTT 减少到 1 RTT，而且安全性也高，具备前向安全性</strong>。</p><p>ECDHE 算法是基于椭圆曲线实现的，不同的椭圆曲线性能也不同，应该尽量<strong>选择 x25519 曲线</strong>，该曲线是目前最快的椭圆曲线。比如在 Nginx 上，可以使用 ssl_ecdh_curve 指令配置想使用的椭圆曲线，把优先使用的放在前面：</p><p><img src="https%E5%8D%8F%E8%AE%AE/11.jpg" alt="1"></p><p>对于对称加密算法方面，如果对安全性不是特别高的要求，可以<strong>选用 AES_128_GCM</strong>，它比 AES_256_GCM 快一些，因为密钥的长度短一些。比如在 Nginx 上，可以使用 ssl_ciphers 指令配置想使用的非对称加密算法和对称加密算法，也就是密钥套件，而且把性能最快最安全的算法放在最前面：</p><p><img src="https%E5%8D%8F%E8%AE%AE/12.jpg" alt="1"></p><h3 id="4-2-TLS-升级"><a href="#4-2-TLS-升级" class="headerlink" title="4.2 TLS 升级"></a>4.2 TLS 升级</h3><p>当然，如果可以，直接把 TLS 1.2 升级成 TLS 1.3，TLS 1.3 大幅度简化了握手的步骤，<strong>完成 TLS 握手只要 1 RTT</strong>，而且安全性更高。</p><p>在 TLS 1.2 的握手中，一般是需要 4 次握手，先要通过 Client Hello （第 1 次握手）和 Server Hello（第 2 次握手） 消息协商出后续使用的加密算法，再互相交换公钥（第 3 和 第 4 次握手），然后计算出最终的会话密钥，下图的左边部分就是 TLS 1.2 的握手过程：</p><p><img src="https%E5%8D%8F%E8%AE%AE/13.jpg" alt="1"></p><p>上图的右边部分就是 TLS 1.3 的握手过程，可以发现 <strong>TLS 1.3 把 Hello 和公钥交换这两个消息合并成了一个消息，于是这样就减少到只需 1 RTT 就能完成 TLS 握手</strong>。</p><p>怎么合并的呢？具体的做法是，客户端在 Client Hello 消息里带上了支持的椭圆曲线，以及这些椭圆曲线对应的公钥。</p><p>服务端收到后，选定一个椭圆曲线等参数，然后返回消息时，带上服务端这边的公钥。经过这 1 个 RTT，双方手上已经有生成会话密钥的材料了，于是客户端计算出会话密钥，就可以进行应用数据的加密传输了。</p><p>而且，TLS1.3 对密码套件进行“减肥”了， <strong>对于密钥交换算法，废除了不支持前向安全性的 RSA 和 DH 算法，只支持 ECDHE 算法</strong>。</p><h1 id="5-参考资料"><a href="#5-参考资料" class="headerlink" title="5. 参考资料"></a>5. 参考资料</h1><ul><li><a href="https://www.ruanyifeng.com/blog/2014/02/ssl_tls.html" target="_blank" rel="noopener">https://www.ruanyifeng.com/blog/2014/02/ssl_tls.html</a></li><li><a href="https://draveness.me/whys-the-design-https-latency/" target="_blank" rel="noopener">https://draveness.me/whys-the-design-https-latency/</a></li><li><a href="https://zhuanlan.zhihu.com/p/344086342" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/344086342</a></li><li><a href="https://zhuanlan.zhihu.com/p/348215533" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/348215533</a></li><li><a href="https://zhuanlan.zhihu.com/p/346489295" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/346489295</a></li></ul></div><div class="reward-container"><div>给作者打赏，鼓励TA抓紧创作！</div><button onclick='var qr=document.getElementById("qr");qr.style.display="none"===qr.style.display?"block":"none"'>打赏</button><div id="qr" style="display:none"><div style="display:inline-block"><img src="/images/wechatpay.jpg" alt="levonfly 微信支付"><p>微信支付</p></div><div style="display:inline-block"><img src="/images/alipay.jpg" alt="levonfly 支付宝"><p>支付宝</p></div></div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/linux/" rel="tag"># linux</a> <a href="/tags/http/" rel="tag"># http</a></div><div class="post-nav"><div class="post-nav-item"><a href="/p/6765e5a5.html" rel="prev" title="mac破解资源软件收集"><i class="fa fa-chevron-left"></i> mac破解资源软件收集</a></div><div class="post-nav-item"><a href="/p/fcd8becb.html" rel="next" title="让自己的网站支持https">让自己的网站支持https <i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments" id="valine-comments"></div><script>window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#1-https-协议"><span class="nav-text">1. https 协议</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-数字证书"><span class="nav-text">2. 数字证书</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-数字证书和-CA-机构"><span class="nav-text">2.1 数字证书和 CA 机构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-数字证书签发和验证流程"><span class="nav-text">2.2 数字证书签发和验证流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-证书链"><span class="nav-text">2.3 证书链</span></a></li></ol></li></ol><li class="nav-item nav-level-1"><a class="nav-link" href="#3-tls-四次握手"><span class="nav-text">3. tls 四次握手</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-客户端向服务端发送-Client-Hello-消息"><span class="nav-text">3.1 客户端向服务端发送 Client Hello 消息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-服务端向客户端发送-Server-Hello-消息"><span class="nav-text">3.2 服务端向客户端发送 Server Hello 消息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-客户端验证-服务器证书-和-协商密钥"><span class="nav-text">3.3 客户端验证 服务器证书 和 协商密钥</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-服务端向客户端发送-Finished-消息"><span class="nav-text">3.4 服务端向客户端发送 Finished 消息</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4-优化https"><span class="nav-text">4. 优化https</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-密钥交换算法优化"><span class="nav-text">4.1 密钥交换算法优化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-TLS-升级"><span class="nav-text">4.2 TLS 升级</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#5-参考资料"><span class="nav-text">5. 参考资料</span></a></li></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="levonfly" src="/images/avatar.jpg"><p class="site-author-name" itemprop="name">levonfly</p><div class="site-description" itemprop="description">Keep it simple, stupid.</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">219</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">44</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">123</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/unix2dos" title="GitHub → https://github.com/unix2dos" rel="noopener" target="_blank"><i class="github fa-fw"></i>GitHub</a> </span><span class="links-of-author-item"><a href="mailto:levonfly@gmail.com" title="E-Mail → mailto:levonfly@gmail.com" rel="noopener" target="_blank"><i class="envelope fa-fw"></i>E-Mail</a> </span><span class="links-of-author-item"><a href="https://twitter.com/levonfly" title="Twitter → https://twitter.com/levonfly" rel="noopener" target="_blank"><i class="twitter fa-fw"></i>Twitter</a> </span><span class="links-of-author-item"><a href="https://weibo.com/l6241425" title="Weibo → https://weibo.com/l6241425" rel="noopener" target="_blank"><i class="weibo fa-fw"></i>Weibo</a></span></div><div class="links-of-blogroll motion-element"><div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i> Links</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><a href="https://luanruisong.com/" title="https://luanruisong.com/" rel="noopener" target="_blank">anwu's blog</a></li></ul></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="beian"><a href="https://beian.miit.gov.cn" rel="noopener" target="_blank">京ICP备20000727号 </a><img src="/images/beian.png" style="display:inline-block"><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=11010502039978" rel="noopener" target="_blank">京公网安备11010502039978号</a></div><div class="copyright">&copy; <span itemprop="copyrightYear">2021</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">levonfly</span></div></div></footer></div><script src="/lib/anime.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script>!function(){var e,t,o,n,r,a=document.getElementsByTagName("link");if(0<a.length)for(i=0;i<a.length;i++)"canonical"==a[i].rel.toLowerCase()&&a[i].href&&(e=a[i].href);t=e?e.split(":")[0]:window.location.protocol.split(":")[0],e=e||window.location.href,window,n=e,r=document.referrer,/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi.test(n)||(o="https"===String(t).toLowerCase()?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif",r?(o+="?r="+encodeURIComponent(document.referrer),n&&(o+="&l="+n)):n&&(o+="?l="+n),(new Image).src=o)}()</script><script src="/js/local-search.js"></script><script>NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : true,
      appId      : 'Y4ry1QHkYxVXKLQBrx6LJXld-gzGzoHsz',
      appKey     : 'TXITOypSvI7JO61NI8EG5exk',
      placeholder: "留下您的小脚丫吧~",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});</script></body></html>