---
title: 加速博客访问国内外访问分流
tags:
  - blog
categories:
  - 5-随笔
  - 个人记录
abbrlink: 5ee5b7c
date: 2020-06-11 00:00:01
---



不只一个人说过，我博客访问的速度真慢。 博客虽然只是记录个人学习历程的地方，但也要记得优化访问速度。 

今天终于有时间折腾下，让网站在国内和国外各备份一份，然后国内的用户访问国内的coding，国外的用户访问国外的github。 

<!-- more -->

# 1. 国内使用coding加速

+ 登录网站, https://wwww.coding.net/, 注册登录

+ 创建项目时候选择DevOps项目, 此处用的自己的用户名`levonfly`, 仓库地址为`git@e.coding.net:levonfly/levonfly.git`

+ 在个人设置里, 配置公钥

+ `ssh -T git@e.coding.net -i ~/.ssh/github-unix2dos`  测试密钥是否能访问

+ 修hexo配置文件

  ```yaml
  deploy:
      -
       type: git
       repo:
          github: git@unix2dos:unix2dos/unix2dos.github.io.git # github地址
          coding: git@e.coding.net:levonfly/levonfly.git #coding地址
       branch: master
  ```

+ 修改ssh配置文件

  ```yaml
  Host coding e.coding.net
  	HostName e.coding.net
  	IdentityFile ~/.ssh/github-unix2dos # 自己的私钥
  	User levonfly
  ```

+ 个人设置->实名认证

+ 项目->持续部署->静态网站->发布网站->立即部署

+ DNS解析 

  CNAME->默认指向coding-pages.com

  CNMA->境外指向github.io

  我的域名`liuvv.com`解析如下

  ```bash
  主机 类型	 线路	 记录值
  www	CNAME	境外	unix2dos.github.io
  www	CNAME	默认	r8ea0k.coding-pages.com
  ```

  

+ 证书申请失败

  申请错误原因是：在验证域名所有权时会定位到 Github Pages 的主机上导致 SSL 证书申请失败

  正确的做法是：先去域名 DNS 把 GitHub 的解析暂停掉，然后再重新申请 SSL 证书，大约十秒左右就能申请成功，然后开启强制 HTTPS 访问

  

+ 测试

  ```bash
  host www.liuvv.com   # 国内测试
  www.liuvv.com is an alias for r8ea0k.coding-pages.com.
  r8ea0k.coding-pages.com has address 150.109.4.162
  r8ea0k.coding-pages.com has address 119.28.218.218
  
  
  host www.liuvv.com  # 国外服务器测试
  www.liuvv.com is an alias for unix2dos.github.io.
  unix2dos.github.io has address 185.199.109.153
  unix2dos.github.io has address 185.199.111.153
  unix2dos.github.io has address 185.199.108.153
  unix2dos.github.io has address 185.199.110.153
  ```

  

  另外可开启和关闭vpn, 刷新博客, 看证书的有效期也能看到区别, 国内外访问同一个地址, 实现了分流. 至此加速大功告成.



# 2. 其他优化方案

### 2.1 静态资源放在 cdn 上

还有一种方案是把生成的静态文件放在国内的CDN上, 来进行加速

可参考: https://github.com/saltbo/uptoc

###  2.2 主题源加载优化

把在NexT主题的_config.yml里面的：

```dart
# Uri of fonts host. E.g. //fonts.googleapis.com (Default)
host:
```

改为：

```dart
# Uri of fonts host. E.g. //fonts.googleapis.com (Default)
host: //fonts.lug.ustc.edu.cn
```

因为`fonts.lug.ustc.edu.cn`是中科大的源，相比之前能快一下

### 2.3 压缩页面

```bash
npm install hexo-neat --save
```

配置文件

```yml
neat_enable: true
neat_html:
  enable: true
  exclude:
    - '**/baidu*.html'
    - '**/google*.html'
neat_css:
  enable: true
  exclude:
    - '**/*.min.css'
neat_js:
  enable: true
  mangle: true
  output:
  compress:
  exclude:
    - '**/*.min.js'
    - '**/jquery.fancybox.pack.js'
    - '**/index.js'
```



### 2.4 懒加载(此处会造成持久链接本地图片不显示)

https://github.com/theme-next/theme-next-jquery-lazyload

```bash
cd themes/next
git clone https://github.com/theme-next/theme-next-jquery-lazyload source/lib/jquery_lazyload

#Enable module in NexT _config.yml file:
lazyload: true
```



### 2.5 图片压缩

https://imageoptim.com/mac

导航到你的markdown索引的图片文件夹，并把里面的图片直接拖入 ImageOptim 就好了，同时压缩完会直接替换，直接commit新的优化的图片即可，原文件会被拉入垃圾箱(mac 的垃圾箱)可恢复，压缩可以在 ImageOptim 的 Preference 里面进行更大的压缩比设置.



### 2.6 测试网页加载速度

https://developers.google.com/speed/pagespeed/insights/



# 3. 参考资料

+ https://www.cnblogs.com/sunhang32/p/11969964.html 
+ https://github.com/saltbo/uptoc
+ https://www.jianshu.com/p/25766dda5a5f

